
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Oncology Admin | Timer Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --purple-btn: #d8b4fe; 
            --purple-dark: #9d50bb;
            --pink: #ec4899;
            --glass: rgba(255, 255, 255, 0.1);
        }
        
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; 
            color: #fff; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.pexels.com/photos/4225880/pexels-photo-4225880.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center;
        }
        
        .admin-ui { 
            width: 85%; max-width: 900px; max-height: 90vh; background: var(--glass); 
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 35px; padding: 35px; text-align: center; position: relative;
        }

        /* قنبلة الانتفاخ */
        #bomb-element {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 100px; height: 100px; background: radial-gradient(circle, #fff, var(--purple-btn));
            border-radius: 50%; z-index: 1000; display: none;
        }

        .inflate-and-burst {
            display: block !important;
            animation: inflate 1.8s cubic-bezier(0.6, 0.04, 0.98, 0.33) forwards;
        }

        @keyframes inflate {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(2); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(40); opacity: 0; }
        }

        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        
        /* أزرار تفاعلية ضاغطة */
        .btn-pro {
            background: var(--purple-btn); color: #2e1065; border: none; padding: 18px; 
            border-radius: 50px; font-weight: 800; font-size: 1rem; cursor: pointer;
            box-shadow: 0 5px 0 #a78bfa; transition: 0.1s; position: relative; top: 0;
        }

        .btn-pro:active {
            top: 4px; box-shadow: 0 1px 0 #a78bfa;
        }

        .teams-container { display: flex; justify-content: center; gap: 25px; margin: 30px 0; }
        .team-slot { 
            padding: 20px; border-radius: 25px; background: rgba(255,255,255,0.05); 
            width: 45%; border: 1px solid rgba(255,255,255,0.1); 
        }
        .score-val { font-size: 5rem; font-weight: 800; display: none; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="bomb-element"></div>

    <div class="admin-ui">
        <h2 style="margin: 0; opacity: 0.7; letter-spacing: 2px;">ONCOLOGY SHOW 2026</h2>
        <div id="timer-display" style="font-size: 6rem; font-weight: 800;">01:00</div>

        <div class="teams-container">
            <div class="team-slot" id="card-pink" style="border-top: 6px solid var(--pink);">
                <h3 style="color: var(--pink); margin: 0;">Team Rose</h3>
                <div id="name-pink" style="font-size: 1.4rem; font-weight: 600;">En attente...</div>
                <div id="status-pink" style="color: #10b981; font-weight: bold; margin-top:5px;"></div>
                <div id="score-pink" class="score-val">0</div>
            </div>

            <div class="team-slot" id="card-purple" style="border-top: 6px solid var(--purple-dark);">
                <h3 style="color: var(--purple-dark); margin: 0;">Team Violette</h3>
                <div id="name-purple" style="font-size: 1.4rem; font-weight: 600;">En attente...</div>
                <div id="status-purple" style="color: #10b981; font-weight: bold; margin-top:5px;"></div>
                <div id="score-purple" class="score-val">0</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-pro" onclick="triggerAction('start')">START</button>
            <button class="btn-pro" onclick="animateBomb()">RESULTS</button>
            <button class="btn-pro" onclick="triggerReset()">RESET</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = { databaseURL: "https://quiz-8016b-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('competition');
        let interval;

        db.on('value', snap => {
            const data = snap.val(); if(!data) return;
            
            document.getElementById('name-pink').innerText = data.teamPink || "En attente...";
            document.getElementById('name-purple').innerText = data.teamPurple || "En attente...";
            document.getElementById('status-pink').innerText = data.finishedPink ? "PRÊT ✓" : "";
            document.getElementById('status-purple').innerText = data.finishedPurple ? "PRÊT ✓" : "";

            // إدارة العداد المنطقية
            if(data.status === 'start' && data.startTime) {
                startTimer(data.startTime);
            } else if (data.status === 'waiting') {
                clearInterval(interval);
                document.getElementById('timer-display').innerText = "01:00";
            }

            if(data.showResults) executeFinalReveal(data);
        });

        function startTimer(st) {
            clearInterval(interval);
            interval = setInterval(() => {
                const rem = 60 - Math.floor((Date.now() - st) / 1000);
                if (rem <= 0) {
                    document.getElementById('timer-display').innerText = "00:00";
                    clearInterval(interval);
                } else {
                    document.getElementById('timer-display').innerText = `00:${rem.toString().padStart(2,'0')}`;
                }
            }, 1000);
        }

        function triggerAction(act) {
            if(act === 'start') {
                db.update({ 
                    status: 'start', 
                    startTime: firebase.database.ServerValue.TIMESTAMP,
                    showResults: false 
                });
            }
        }

        function triggerReset() {
            if(confirm("Réinitialiser la compétition ?")) {
                clearInterval(interval);
                // مسح شامل للبيانات لضمان تصفير الوقت تماماً
                db.set({ 
                    status: 'waiting',
                    teamPink: "",
                    teamPurple: "",
                    scorePink: 0,
                    scorePurple: 0,
                    finishedPink: false,
                    finishedPurple: false,
                    showResults: false,
                    startTime: null 
                }).then(() => {
                    location.reload();
                });
            }
        }

        function animateBomb() {
            document.getElementById('bomb-element').classList.add('inflate-and-burst');
            setTimeout(() => { db.update({ showResults: true }); }, 1500);
        }

        function executeFinalReveal(data) {
            document.getElementById('timer-display').classList.add('hidden');
            const sP = data.scorePink || 0;
            const sV = data.scorePurple || 0;
            const elP = document.getElementById('score-pink');
            const elV = document.getElementById('score-purple');
            
            elP.innerText = sP; elV.innerText = sV;
            elP.style.display = 'block'; elV.style.display = 'block';

            let winnerColor = (sP > sV) ? '#ec4899' : (sV > sP ? '#9d50bb' : ['#ec4899', '#9d50bb']);
            confetti({
                particleCount: 250, spread: 90, origin: { y: 0.6 },
                colors: Array.isArray(winnerColor) ? winnerColor : [winnerColor, '#ffffff']
            });
        }
    </script>
</body>
</html>
